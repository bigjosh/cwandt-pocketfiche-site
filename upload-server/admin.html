<!doctype html>

<!--

  If you are a hacker, please do not hack on this. This site is only up for a couple of weeks so it was not worth the effort for me to harden it. 
  None of the data here is canonical. If you figure out a way to upload more tiles or delete someoneelses tiles, you are just makimg work
  for me to fix it. There is nothing to gain except wasting your time and my time. No glory.

  Thanks,
  josh
  
-->


<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Generate Upload Code</title>
</head>
<body>
  <div>
    <h1>Generate Backer Upload Code</h1>
    <p>Create a unique access code for a backer to upload their parcel image.</p>
    
    <!-- Form to generate code -->
    <form id="generate-form">
      <p>
        <label for="backer-id">Backer ID *</label><br>
        <input type="text" id="backer-id" name="backer-id" required placeholder="Enter backer identifier" />
      </p>
      
      <p>
        <label for="notes">Notes</label><br>
        <textarea id="notes" name="notes" placeholder="Optional notes about this backer"></textarea>
      </p>
      
      <p>
        <button type="submit" id="submit-btn">Generate Code</button>
      </p>
    </form>
    
    <!-- Error message -->
    <div id="error-message"></div>
    
    <!-- Success display (hidden initially) -->
    <div id="success-display" style="display:none;">
      <h2>Code Generated Successfully!</h2>
      
      <p>Access Code:</p>
      <p><b id="code-value"></b></p>
      <p>Backer ID:</p>
      <p><b id="backer-id-display"></b></p>
      
      <p>Send this URL to the backer:</p>
      <p id="url-display"></p>
      
      <p>
        <button type="button" id="copy-btn">Copy URL to Clipboard</button>
        <button type="button" id="reset-btn">Generate Another</button>
      </p>
      
      <div id="copy-message"></div>
    </div>
    
    <hr>
    
    <!-- Show codes button -->
    <p>
      <button type="button" id="show-codes-btn">Show Codes</button>
    </p>
    
    <!-- Codes display -->
    <div id="codes-display"></div>
  </div>

  <script>
    // Get admin-id from URL hash fragment
    const hash = window.location.hash.slice(1); // Remove the '#'
    const adminId = hash || null;
    
    if (!adminId) {
      document.body.innerHTML = '<div><h1>Error</h1><p>No admin-id provided in URL. Use: admin.html#YOUR_ADMIN_ID</p></div>';
    }
    
    const form = document.getElementById('generate-form');
    const submitBtn = document.getElementById('submit-btn');
    const errorMessage = document.getElementById('error-message');
    const successDisplay = document.getElementById('success-display');
    const codeValue = document.getElementById('code-value');
    const backerIdDisplay = document.getElementById('backer-id-display');
    const urlDisplay = document.getElementById('url-display');
    const copyBtn = document.getElementById('copy-btn');
    const resetBtn = document.getElementById('reset-btn');
    const copyMessage = document.getElementById('copy-message');
    const showCodesBtn = document.getElementById('show-codes-btn');
    const codesDisplay = document.getElementById('codes-display');
    
    // Handle form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Clear previous messages
      errorMessage.textContent = '';
      errorMessage.style.display = 'none';
      
      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Generating...';
      
      try {
        // Get form data
        const formData = new FormData();
        formData.append('command', 'generate-code');
        formData.append('admin-id', adminId);
        formData.append('backer-id', document.getElementById('backer-id').value.trim());
        formData.append('notes', document.getElementById('notes').value.trim());
        
        // Send POST request
        const response = await fetch('cgi-bin/app.py', {
          method: 'POST',
          body: formData
        });
        
        // Always expect JSON response (server always returns JSON now)
        const data = await response.json();
        
        if (data.status === 'success') {
          // Show success display
          const backerId = document.getElementById('backer-id').value.trim();
          codeValue.textContent = data.code;
          backerIdDisplay.textContent = backerId;
          
          // Build upload URL with hash fragment
          const uploadUrl = `${window.location.origin}${window.location.pathname.replace('admin.html', 'upload.html')}#${data.code}`;
          urlDisplay.textContent = uploadUrl;
          
          // Hide form, show success
          form.style.display = 'none';
          successDisplay.style.display = 'block';
          
        } else {
          // Server returned error status
          throw new Error(data.message || 'Failed to generate code');
        }
        
      } catch (error) {
        // Show error message
        errorMessage.textContent = `Error: ${error.message}`;
        errorMessage.style.display = 'block';
        
      } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.textContent = 'Generate Code';
      }
    });
    
    // Copy URL to clipboard
    copyBtn.addEventListener('click', async () => {
      try {
        const url = urlDisplay.textContent;
        await navigator.clipboard.writeText(url);
        
        copyMessage.textContent = 'URL copied to clipboard!';
        copyMessage.style.display = 'block';
        
        // Hide message after 3 seconds
        setTimeout(() => {
          copyMessage.style.display = 'none';
        }, 3000);
        
      } catch (error) {
        alert('Failed to copy to clipboard. Please copy manually.');
      }
    });
    
    // Reset form
    resetBtn.addEventListener('click', () => {
      // Clear form
      form.reset();
      
      // Hide success, show form
      successDisplay.style.display = 'none';
      form.style.display = 'block';
      
      // Clear messages
      errorMessage.style.display = 'none';
      copyMessage.style.display = 'none';
    });
    
    // Codes data and sort state
    let allCodes = [];
    let sortField = 'code';
    let sortAscending = true;
    
    // Build and display codes table
    function displayCodesTable() {
      let html = '<h2>All Codes</h2>';
      
      if (allCodes.length === 0) {
        html += '<p>No codes found.</p>';
      } else {
        html += '<table border="1" cellpadding="5" cellspacing="0">';
        html += '<tr>';
        html += `<th><a href="#" onclick="sortCodes('code'); return false;">Code ${sortField === 'code' ? (sortAscending ? '▲' : '▼') : ''}</a></th>`;
        html += `<th><a href="#" onclick="sortCodes('backer-id'); return false;">Backer ID ${sortField === 'backer-id' ? (sortAscending ? '▲' : '▼') : ''}</a></th>`;
        html += '<th>Notes</th>';
        html += '<th>Status</th>';
        html += `<th><a href="#" onclick="sortCodes('parcel-location'); return false;">Location ${sortField === 'parcel-location' ? (sortAscending ? '▲' : '▼') : ''}</a></th>`;
        html += '</tr>';
        
        allCodes.forEach(code => {
          html += '<tr>';
          
          // Make code a link to upload page with hash fragment
          const uploadUrl = `upload.html#${encodeURIComponent(code.code)}`;
          html += `<td><b><a href="${uploadUrl}" target="_blank" rel="noopener">${code.code}</a></b></td>`;
          
          html += `<td>${code['backer-id']}</td>`;
          html += `<td>${code.notes || ''}</td>`;
          html += `<td>${code.status}</td>`;
          
          // Make parcel-location a link if it exists
          if (code['parcel-location']) {
            const location = code['parcel-location'];
            const viewerUrl = `/?parcel=${encodeURIComponent(location)}`;
            html += `<td><a href="${viewerUrl}" target="_blank" rel="noopener">${location}</a></td>`;
          } else {
            html += `<td></td>`;
          }
          
          html += '</tr>';
        });
        
        html += '</table>';
      }
      
      codesDisplay.innerHTML = html;
    }
    
    // Sort codes by field
    window.sortCodes = function(field) {
      // Toggle direction if clicking same field
      if (sortField === field) {
        sortAscending = !sortAscending;
      } else {
        sortField = field;
        sortAscending = true;
      }
      
      // Sort the codes array
      allCodes.sort((a, b) => {
        let aVal = a[field] || '';
        let bVal = b[field] || '';
        
        if (sortAscending) {
          return aVal.localeCompare(bVal);
        } else {
          return bVal.localeCompare(aVal);
        }
      });
      
      // Rebuild table
      displayCodesTable();
    };
    
    // Show codes
    showCodesBtn.addEventListener('click', async () => {
      showCodesBtn.disabled = true;
      showCodesBtn.textContent = 'Loading...';
      
      try {
        // Fetch codes
        const response = await fetch(`cgi-bin/app.py?command=get-codes&admin-id=${encodeURIComponent(adminId)}`);
        
        // Always expect JSON response (server always returns JSON now)
        const data = await response.json();
        
        if (data.status === 'success') {
          // Store codes and display
          allCodes = data.codes;
          sortField = 'code';
          sortAscending = true;
          displayCodesTable();
          
        } else {
          throw new Error(data.message || 'Failed to fetch codes');
        }
        
      } catch (error) {
        codesDisplay.innerHTML = `<p><b>Error:</b> ${error.message}</p>`;
        
      } finally {
        showCodesBtn.disabled = false;
        showCodesBtn.textContent = 'Show Codes';
      }
    });
  </script>
</body>
</html>
