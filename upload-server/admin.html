<!doctype html>

<!--

  If you are a hacker, please do not hack on this. This site is only up for a couple of weeks so it was not worth the effort for me to harden it. 
  None of the data here is canonical. If you figure out a way to upload more tiles or delete someoneelses tiles, you are just makimg work
  for me to fix it. There is nothing to gain except wasting your time and my time. No glory.

  Thanks,
  josh
  
-->


<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Generate Upload Code</title>
</head>
<body>
  <div>
    <h1>Generate Backer Upload Code</h1>
    <p>Create a unique access code for a backer to upload their parcel image.</p>
    
    <!-- Form to generate code -->
    <form id="generate-form">
      <p>
        <label for="backer-id">Backer ID *</label><br>
        <small style="color: red;">Required. Freeform, but use backer number for backers. Autoincrements.</small><br>
        <input type="text" id="backer-id" name="backer-id" required placeholder="Enter backer identifier" />
      </p>
      
      <p>
        <label for="notes">Notes</label><br>
        <textarea id="notes" name="notes" placeholder="Optional notes about this backer"></textarea>
      </p>
      
      <p>
        <label for="parcel-location">Parcel Location</label><br>
        <small style="color: red;">Preallocates specified parcel for this access code.</small><br>
        <input type="text" id="parcel-location" name="parcel-location" 
               placeholder="e.g., A1, B12, AL38 (leave blank for new upload)" 
               pattern="[A-Za-z]{1,2}\d{1,2}" 
               />
        <br>
        
      </p>
      
      <p>
        <button type="submit" id="submit-btn">Generate Code</button>
      </p>
    </form>
    
    <!-- Error message -->
    <div id="error-message"></div>
    
    <!-- Success display (hidden initially) -->
    <div id="success-display" style="display:none;">
      <h2>Code Generated Successfully!</h2>
      
      <p>Access Code:</p>
      <p><b id="code-value"></b></p>
      <p>Backer ID:</p>
      <p><b id="backer-id-display"></b></p>
      
      <p>Send this URL to the backer:</p>
      <p><a id="url-display" href="" target="_blank" rel="noopener"></a></p>
      
      <p>
        <button type="button" id="copy-btn">Copy URL to Clipboard</button>
        <button type="button" id="reset-btn">Generate Another</button>
      </p>
      
      <div id="copy-message"></div>
    </div>
    
    <hr>
    
    <!-- Show codes button -->
    <p>
      <button type="button" id="show-codes-btn">Show Codes</button>
    </p>
    
    <!-- Codes display -->
    <div id="codes-display"></div>
  </div>

  <script>
    // Get admin-id from URL query parameter
    const urlParams = new URLSearchParams(window.location.search);
    const adminId = urlParams.get('admin-id');
    
    if (!adminId) {
      document.body.innerHTML = '<div><h1>Error</h1><p>No admin-id provided in URL. Use: admin.html?admin-id=YOUR_ADMIN_ID</p></div>';
    }
    
    const form = document.getElementById('generate-form');
    const submitBtn = document.getElementById('submit-btn');
    const errorMessage = document.getElementById('error-message');
    const successDisplay = document.getElementById('success-display');
    const codeValue = document.getElementById('code-value');
    const backerIdDisplay = document.getElementById('backer-id-display');
    const urlDisplay = document.getElementById('url-display');
    const copyBtn = document.getElementById('copy-btn');
    const resetBtn = document.getElementById('reset-btn');
    const copyMessage = document.getElementById('copy-message');
    const showCodesBtn = document.getElementById('show-codes-btn');
    const codesDisplay = document.getElementById('codes-display');
    
    // Handle form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Clear previous messages
      errorMessage.textContent = '';
      errorMessage.style.display = 'none';
      
      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Generating...';
      
      try {
        // Get form data
        const formData = new FormData();
        formData.append('command', 'generate-code');
        formData.append('admin-id', adminId);
        formData.append('backer-id', document.getElementById('backer-id').value.trim());
        formData.append('notes', document.getElementById('notes').value.trim());
        
        // Add optional parcel-location if provided
        const parcelLocation = document.getElementById('parcel-location').value.trim().toUpperCase();
        if (parcelLocation) {
          formData.append('parcel-location', parcelLocation);
        }
        
        // Send POST request
        const response = await fetch('cgi-bin/app.py', {
          method: 'POST',
          body: formData
        });
        
        // Always expect JSON response (server always returns JSON now)
        const data = await response.json();
        
        if (data.status === 'success') {
          // Show success display
          const backerId = document.getElementById('backer-id').value.trim();
          codeValue.textContent = data.code;
          backerIdDisplay.textContent = backerId;
          
          // Build upload URL with query parameter
          const uploadUrl = `${window.location.origin}${window.location.pathname.replace('admin.html', 'upload.html')}?code=${data.code}`;
          urlDisplay.textContent = uploadUrl;
          urlDisplay.href = uploadUrl;
          
          // Store current backer-id for auto-increment on reset
          form.dataset.lastBackerId = backerId;
          
          // Hide form, show success
          form.style.display = 'none';
          successDisplay.style.display = 'block';
          
        } else {
          // Server returned error status
          throw new Error(data.message || 'Failed to generate code');
        }
        
      } catch (error) {
        // Show error message
        errorMessage.textContent = `Error: ${error.message}`;
        errorMessage.style.display = 'block';
        
      } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.textContent = 'Generate Code';
      }
    });
    
    // Copy URL to clipboard
    copyBtn.addEventListener('click', async () => {
      try {
        const url = urlDisplay.textContent;
        await navigator.clipboard.writeText(url);
        
        copyMessage.textContent = 'URL copied to clipboard!';
        copyMessage.style.display = 'block';
        
        // Hide message after 3 seconds
        setTimeout(() => {
          copyMessage.style.display = 'none';
        }, 3000);
        
      } catch (error) {
        alert('Failed to copy to clipboard. Please copy manually.');
      }
    });
    
    // Reset form
    resetBtn.addEventListener('click', () => {
      // Get last backer-id and auto-increment if it has a number at the end
      const lastBackerId = form.dataset.lastBackerId || '';
      let nextBackerId = lastBackerId;
      
      if (lastBackerId) {
        // Match pattern: text followed by number at the end (e.g., "backer123" or "user-42")
        const match = lastBackerId.match(/^(.*?)(\d+)$/);
        if (match) {
          const prefix = match[1];  // Everything before the number
          const number = parseInt(match[2], 10);  // The number
          nextBackerId = prefix + (number + 1);  // Increment
        }
      }
      
      // Clear form
      form.reset();
      
      // Restore and increment backer-id
      if (nextBackerId) {
        document.getElementById('backer-id').value = nextBackerId;
      }
      
      // Hide success, show form
      successDisplay.style.display = 'none';
      form.style.display = 'block';
      
      // Clear messages
      errorMessage.style.display = 'none';
      copyMessage.style.display = 'none';
    });
    
    // Codes data and sort state
    let allCodes = [];
    let sortField = 'code';
    let sortAscending = true;
    
    // Delete image (allows re-upload to same location)
    window.deleteImage = async function(code) {
      if (!confirm('Delete the uploaded image? This will allow the user to re-upload to the same location.')) {
        return;
      }
      
      try {
        const formData = new FormData();
        formData.append('command', 'delete-image');
        formData.append('admin-id', adminId);
        formData.append('code', code);
        
        const response = await fetch('cgi-bin/app.py', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
          alert('Image deleted successfully!');
          // Refresh the codes table
          showCodesBtn.click();
        } else {
          alert('Error: ' + (data.message || 'Failed to delete image'));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    };
    
    // Delete location and image (makes location available for others)
    window.deleteLocation = async function(code) {
      if (!confirm('Delete the location assignment? This will delete both the location and image files, making the location available for others to claim.')) {
        return;
      }
      
      try {
        const formData = new FormData();
        formData.append('command', 'delete-location');
        formData.append('admin-id', adminId);
        formData.append('code', code);
        
        const response = await fetch('cgi-bin/app.py', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
          alert('Location and image deleted successfully!');
          // Refresh the codes table
          showCodesBtn.click();
        } else {
          alert('Error: ' + (data.message || 'Failed to delete location'));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    };
    
    // Show notes popup
    window.showNotesPopup = function(notes) {
      // Create modal overlay
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;';
      
      // Create modal content
      const modal = document.createElement('div');
      modal.style.cssText = 'background: white; padding: 20px; border-radius: 5px; max-width: 600px; max-height: 80%; overflow: auto; position: relative;';
      
      // Add close button
      const closeBtn = document.createElement('button');
      closeBtn.textContent = 'Close';
      closeBtn.style.cssText = 'position: absolute; top: 10px; right: 10px;';
      closeBtn.onclick = () => document.body.removeChild(overlay);
      
      // Add notes content (preserve line breaks)
      const content = document.createElement('pre');
      content.style.cssText = 'white-space: pre-wrap; word-wrap: break-word; margin-top: 30px;';
      content.textContent = notes;
      
      modal.appendChild(closeBtn);
      modal.appendChild(content);
      overlay.appendChild(modal);
      
      // Close on overlay click
      overlay.onclick = (e) => {
        if (e.target === overlay) {
          document.body.removeChild(overlay);
        }
      };
      
      document.body.appendChild(overlay);
    };
    
    // Build and display codes table
    function displayCodesTable() {
      let html = '<h2>All Codes</h2>';
      
      if (allCodes.length === 0) {
        html += '<p>No codes found.</p>';
      } else {
        html += '<table border="1" cellpadding="5" cellspacing="0">';
        html += '<tr>';
        html += `<th><a href="#" onclick="sortCodes('code'); return false;">Code ${sortField === 'code' ? (sortAscending ? '▲' : '▼') : ''}</a></th>`;
        html += `<th><a href="#" onclick="sortCodes('backer-id'); return false;">Backer ID ${sortField === 'backer-id' ? (sortAscending ? '▲' : '▼') : ''}</a></th>`;
        html += `<th><a href="#" onclick="sortCodes('admin-name'); return false;">Created By ${sortField === 'admin-name' ? (sortAscending ? '▲' : '▼') : ''}</a></th>`;
        html += `<th><a href="#" onclick="sortCodes('timestamp'); return false;">Created ${sortField === 'timestamp' ? (sortAscending ? '▲' : '▼') : ''}</a></th>`;
        html += `<th><a href="#" onclick="sortCodes('parcel-location'); return false;">Location ${sortField === 'parcel-location' ? (sortAscending ? '▲' : '▼') : ''}</a></th>`;
        html += `<th><a href="#" onclick="sortCodes('status'); return false;">Status ${sortField === 'status' ? (sortAscending ? '▲' : '▼') : ''}</a></th>`;
        html += '<th>Notes</th>';
        html += '</tr>';
        
        allCodes.forEach(code => {
          html += '<tr>';
          
          // Make code a link to upload page with query parameter
          const uploadUrl = `upload.html?code=${encodeURIComponent(code.code)}`;
          html += `<td><b><a href="${uploadUrl}" target="_blank" rel="noopener">${code.code}</a></b></td>`;
          
          html += `<td>${code['backer-id']}</td>`;
          html += `<td>${code['admin-name'] || ''}</td>`;
          
          // Format timestamp in ISO 8601 (truncate milliseconds and zone)
          const timestamp = code.timestamp;
          let formattedDate = '';
          if (timestamp) {
            const date = new Date(timestamp * 1000); // Convert Unix timestamp to milliseconds
            formattedDate = date.toISOString().split('.')[0]; // Remove .000Z
          }
          html += `<td>${formattedDate}</td>`;
          
          // Make parcel-location a link if it exists
          if (code['parcel-location']) {
            const location = code['parcel-location'];
            const viewerUrl = `/?parcel=${encodeURIComponent(location)}`;
            html += `<td><a href="${viewerUrl}" target="_blank" rel="noopener">${location}</a> `;
            html += `<a href="#" onclick="deleteLocation('${code.code}'); return false;" style="color: red; text-decoration: none;" title="Delete location and image (makes location available for others)">🗑️</a>`;
            html += `</td>`;
          } else {
            html += `<td></td>`;
          }
          
          // Status - add delete icon if uploaded
          if (code.status === 'uploaded') {
            html += `<td>${code.status} `;
            html += `<a href="#" onclick="deleteImage('${code.code}'); return false;" style="color: red; text-decoration: none;" title="Delete image (allows re-upload to same location)">🗑️</a>`;
            html += `</td>`;
          } else {
            html += `<td>${code.status}</td>`;
          }
          
          // Notes last (all the way to the right)
          const notes = code.notes || '';
          if (notes.length > 20) {
            const truncated = notes.substring(0, 20);
            const escapedNotes = notes.replace(/'/g, "\\'").replace(/\n/g, '\\n').replace(/\r/g, '');
            html += `<td>${truncated}<a href="#" onclick="showNotesPopup('${escapedNotes}'); return false;">...</a></td>`;
          } else {
            html += `<td>${notes}</td>`;
          }
          
          html += '</tr>';
        });
        
        html += '</table>';
      }
      
      codesDisplay.innerHTML = html;
    }
    
    // Sort codes by field
    window.sortCodes = function(field) {
      // Toggle direction if clicking same field
      if (sortField === field) {
        sortAscending = !sortAscending;
      } else {
        sortField = field;
        sortAscending = true;
      }
      
      // Sort the codes array
      allCodes.sort((a, b) => {
        let aVal = a[field] || '';
        let bVal = b[field] || '';
        
        // Numeric sort for timestamp
        if (field === 'timestamp') {
          aVal = a[field] || 0;
          bVal = b[field] || 0;
          return sortAscending ? aVal - bVal : bVal - aVal;
        }
        
        // String sort for other fields
        if (sortAscending) {
          return aVal.localeCompare(bVal);
        } else {
          return bVal.localeCompare(aVal);
        }
      });
      
      // Rebuild table
      displayCodesTable();
    };
    
    // Show codes
    showCodesBtn.addEventListener('click', async () => {
      showCodesBtn.disabled = true;
      showCodesBtn.textContent = 'Loading...';
      
      try {
        // Fetch codes
        const response = await fetch(`cgi-bin/app.py?command=get-codes&admin-id=${encodeURIComponent(adminId)}`);
        
        // Always expect JSON response (server always returns JSON now)
        const data = await response.json();
        
        if (data.status === 'success') {
          // Store codes and display
          allCodes = data.codes;
          sortField = 'code';
          sortAscending = true;
          displayCodesTable();
          
        } else {
          throw new Error(data.message || 'Failed to fetch codes');
        }
        
      } catch (error) {
        codesDisplay.innerHTML = `<p><b>Error:</b> ${error.message}</p>`;
        
      } finally {
        showCodesBtn.disabled = false;
        showCodesBtn.textContent = 'Show Codes';
      }
    });
  </script>
</body>
</html>
