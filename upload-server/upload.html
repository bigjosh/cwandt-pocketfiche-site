<!doctype html>

<!--

  If you are a hacker, please do not hack on this. This site is only up for a couple of weeks so it was not worth the effort for me to harden it. 
  None of the data here is canonical. If you figure out a way to upload more tiles or delete someoneelses tiles, you are just makimg work
  for me to fix it. There is nothing to gain except wasting your time and my time. No glory.

  Thanks,
  josh
  
-->

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Upload Your Parcel Image</title>
  <link rel="stylesheet" href="style.css" />
  <meta name="referrerpolicy" content="no-referrer" />
</head>
<body>
  <div class="container">
    <!-- Header (hidden after successful upload) -->
    <div id="upload-header">
      <h1>Upload Your Parcel Image</h1>
    </div>
    
    <!-- Loading state -->
    <div id="loading-state">
      <div class="spinner"></div>
      <p style="text-align: center; margin-top: 20px;">Checking access code...</p>
    </div>
    
    <!-- Upload form -->
    <div id="upload-form" class="hidden">
      <h2>Step 1: Select Your Image</h2>
      <p style="font-size: 12px; color: #888;">Best to upload a 500x500 1-bit black-and-white image, but if you upload something else, we will try our best to convert it for you.</p>
      
      <!-- Drop zone -->
      <div id="drop-zone">
        <p style="font-size: 20px;">üìÅ</p>
        <p>Drag and drop an image here</p>
        <p>or click to select a file</p>
      </div>
      <input type="file" id="file-input" accept="image/*" />
      
      <!-- Preview -->
      <div id="preview-container">
        <h2>Image Preview</h2>
        <canvas id="preview-image"></canvas>
        <p style="text-align: center; margin-top: 15px; font-size: 12px; color: #888;">
          Don't like the preview? Try seletcing a different image!
        </p>
      </div>
      
      <!-- Location selection -->
      <div id="location-section" class="hidden">
        <h2>Step 2: Choose Parcel Location</h2>
        <p>Enter a location from A1 to AL38</p>
        <p>See the parcel map <a href="/?names=true" target="_blank">here</a></p>
        
        <label for="parcel-location">Parcel Location</label>
        <input type="text" id="parcel-location" name="parcel-location" 
               required placeholder="e.g., A1, B12, AL38" 
               pattern="[A-Z]{1,2}\d{1,2}" 
               style="text-transform: uppercase;" />
        
        <div class="button-row">
          <button type="button" id="upload-btn">Upload Image</button>
        </div>
      </div>
    </div>
    
    <!-- Error Modal -->
    <div id="error-modal" class="modal hidden">
      <div class="modal-content">
        <h3>Error</h3>
        <p id="error-modal-message"></p>
        <button id="error-modal-close">OK</button>
      </div>
    </div>
    
    <!-- Success display -->
    <div id="success-display" class="hidden">
      <h2>Upload Successful!</h2>
      <p>Your parcel image has been uploaded to location: <strong id="uploaded-location"></strong></p>
      <p>Our parcel integration team is on it. You should see it in the <a id="viewer-link" href="#" rel="noopener" target="_blank">viewer</a> within a few minutes.</p>
    </div>
  </div>

  <script>
    // Get code from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    
    if (!code) {
      document.body.innerHTML = '<div class="container"><h1>Error</h1><p>No access code provided in URL</p></div>';
    }
    
    // Elements
    const uploadHeader = document.getElementById('upload-header');
    const loadingState = document.getElementById('loading-state');
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const previewContainer = document.getElementById('preview-container');
    const previewCanvas = document.getElementById('preview-image');
    const locationSection = document.getElementById('location-section');
    const parcelLocationInput = document.getElementById('parcel-location');
    const uploadBtn = document.getElementById('upload-btn');
    const uploadForm = document.getElementById('upload-form');
    const successDisplay = document.getElementById('success-display');
    const uploadedLocation = document.getElementById('uploaded-location');
    const viewerLink = document.getElementById('viewer-link');
    const errorModal = document.getElementById('error-modal');
    const errorModalMessage = document.getElementById('error-modal-message');
    const errorModalClose = document.getElementById('error-modal-close');
    
    let processedImageBlob = null;  // Store the processed image
    
    // Check upload status on page load (blocks interaction until complete)
    async function checkUploadStatus() {
      try {
        const response = await fetch(`cgi-bin/app.py?command=get-parcel&code=${encodeURIComponent(code)}`);
        
        // Always expect JSON response (server always returns JSON now)
        const data = await response.json();
        
        // Hide loading state
        loadingState.classList.add('hidden');
        
        if (data.status === 'error') {
          // Code not found or other error - not authorized
          document.body.innerHTML = '<div class="container"><h1>Not Authorized</h1><p>Invalid or expired access code.</p><p>Please <a href="https://help.kickstarter.com/hc/en-us/articles/360011239834-How-to-message-a-project-creator">message us on Kickstarter</a> if you think this is in error!</p></div>';
          return;
        } else if (data.status === 'success') {
          // Already uploaded - show success message with image
          uploadHeader.classList.add('hidden');
          const parcelLocation = data['parcel-location'];
          uploadedLocation.textContent = parcelLocation;
          
          // Set viewer link
          const viewerLink = document.getElementById('viewer-link');
          viewerLink.href = `/?parcel=${encodeURIComponent(parcelLocation)}`;
          
          successDisplay.classList.remove('hidden');
          return;
        } else if (data.status === 'free') {
          // Valid code, no upload yet - show upload form
          uploadForm.classList.remove('hidden');
          return;
        }
      } catch (error) {
        console.error('Failed to check upload status:', error);
        // Network or parsing error - hide loading and show form anyway
        loadingState.classList.add('hidden');
        uploadForm.classList.remove('hidden');
      }
    }
    
    // Check status when page loads
    checkUploadStatus();
    
    // Drop zone click opens file dialog
    dropZone.addEventListener('click', () => {
      fileInput.click();
    });
    
    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
    });
    
    // Highlight drop zone when file is dragged over
    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => {
        dropZone.classList.add('drag-over');
      });
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => {
        dropZone.classList.remove('drag-over');
      });
    });
    
    // Handle dropped files
    dropZone.addEventListener('drop', (e) => {
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    });
    
    // Handle selected files
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
      }
    });
    
    // Handle file selection
    function handleFile(file) {
      // Validate file type
      if (!file.type.startsWith('image/')) {
        showError('Please select an image file');
        return;
      }
      
      // Read and process the image
      const reader = new FileReader();
      reader.onload = (e) => {
        processImage(e.target.result);
      };
      reader.onerror = () => {
        showError('Failed to read file');
      };
      reader.readAsDataURL(file);
    }
    
    // Process image to 500x500 1-bit black-and-white PNG
    function processImage(imageDataUrl) {
      const img = new Image();
      img.onload = () => {
        try {
          // Create canvas for processing
          const canvas = document.createElement('canvas');
          canvas.width = 500;
          canvas.height = 500;
          const ctx = canvas.getContext('2d');
          
          // Draw image scaled to 500x500
          ctx.drawImage(img, 0, 0, 500, 500);
          
          // Get pixel data
          const imageData = ctx.getImageData(0, 0, 500, 500);
          const pixels = imageData.data;
          
          // Convert to black and white (1-bit)
          // Use simple threshold: brightness >= 50% = white, else black
          for (let i = 0; i < pixels.length; i += 4) {
            const r = pixels[i];
            const g = pixels[i + 1];
            const b = pixels[i + 2];
            
            // Calculate brightness
            const brightness = (r + g + b) / 3;
            
            // Threshold to black or white
            const value = brightness >= 127.5 ? 255 : 0;
            pixels[i] = value;      // R
            pixels[i + 1] = value;  // G
            pixels[i + 2] = value;  // B
            // Alpha stays the same
          }
          
          // Put processed data back
          ctx.putImageData(imageData, 0, 0);
          
          // Convert to blob
          canvas.toBlob((blob) => {
            if (!blob) {
              showError('Failed to process image');
              return;
            }
            
            processedImageBlob = blob;
            
            // Show preview
            previewCanvas.width = 500;
            previewCanvas.height = 500;
            const previewCtx = previewCanvas.getContext('2d');
            previewCtx.putImageData(imageData, 0, 0);
            
            // Show preview and location section
            previewContainer.classList.add('visible');
            locationSection.classList.remove('hidden');
            
          }, 'image/png');
          
        } catch (error) {
          showError(`Failed to process image: ${error.message}`);
        }
      };
      img.onerror = () => {
        showError('Failed to load image');
      };
      img.src = imageDataUrl;
    }
    
    // Upload button
    uploadBtn.addEventListener('click', async () => {
      // Validate inputs
      if (!processedImageBlob) {
        showError('Please select an image first');
        return;
      }
      
      const location = parcelLocationInput.value.trim().toUpperCase();
      if (!location) {
        showError('Please enter a parcel location');
        return;
      }
      
      // Validate location format
      if (!/^[A-Z]{1,2}\d{1,2}$/.test(location)) {
        showError('Invalid location format. Use uppercase letters and numbers (e.g., A1, B12, AL38)');
        return;
      }
      
      // Disable upload button
      uploadBtn.disabled = true;
      uploadBtn.textContent = 'Uploading...';
      
      try {
        // Create form data
        const formData = new FormData();
        formData.append('command', 'upload');
        formData.append('code', code);
        formData.append('parcel-location', location);
        formData.append('image', processedImageBlob, 'parcel.png');
        
        // Send POST request
        const response = await fetch('cgi-bin/app.py', {
          method: 'POST',
          body: formData
        });
        
        // Always parse JSON response (server always returns JSON)
        const data = await response.json();
        
        if (data.status === 'success') {
          // Show success with uploaded image
          uploadHeader.classList.add('hidden');
          const parcelLocation = data.location;
          uploadedLocation.textContent = parcelLocation;
          
          // Set viewer link
          const viewerLink = document.getElementById('viewer-link');
          viewerLink.href = `/?parcel=${encodeURIComponent(parcelLocation)}`;
          
          uploadForm.classList.add('hidden');
          successDisplay.classList.remove('hidden');
          
        } else if (data.status === 'used') {
          // Code already used
          showError(`This access code has already been used to upload to location ${data.location}`);
          
        } else if (data.status === 'taken') {
          // Location already taken
          showError(`Location ${data.location} is already taken. Please choose a different location.`);
          
        } else if (data.status === 'error') {
          // General error (auth, validation, etc.)
          showError(data.message || 'Upload failed');
          
        } else {
          // Unknown status
          showError('Upload failed with unknown status');
        }
        
      } catch (error) {
        showError(`Error: ${error.message}`);
        
      } finally {
        // Re-enable upload button
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Upload Image';
      }
    });
    
    // Show error modal
    function showError(message) {
      errorModalMessage.textContent = message;
      errorModal.classList.remove('hidden');
    }
    
    // Close error modal
    errorModalClose.addEventListener('click', () => {
      errorModal.classList.add('hidden');
    });
    
    // Close modal on background click
    errorModal.addEventListener('click', (e) => {
      if (e.target === errorModal) {
        errorModal.classList.add('hidden');
      }
    });
    
    // Force uppercase in location input
    parcelLocationInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.toUpperCase();
    });
  </script>
</body>
</html>
